<!-- Custom REPL Script -->
<script>
  document.querySelectorAll(".repl").forEach((replElement) => {
    const iframeElement = replElement.querySelector("iframe");

    const id = replElement.getAttribute("data-id");
    const lang = replElement.getAttribute("data-lang");
    const code = replElement.nextElementSibling.innerText.trim();
    let theme = mapTheme(localStorage.getItem("mdbook-theme"));

    const postmessage = (msg) => iframeElement.contentWindow.postMessage({ repl: msg }, "*");

    function mapTheme(bookTheme) {
      if (bookTheme === "coal" || bookTheme === "navy" || bookTheme === "ayu") return "dark";
      else return "light";
    }

    window.addEventListener("message", (event) => {
      if (event.source === window || !event.data.repl) return;

      const repl = event.data.repl;
      // if id is empty means iframe is first loaded, so we send configurations to it
      if (repl.id === "") postmessage({ id, editor: { theme, lang, code, defaultCode: code } });
      // if id is not empty and it's the same as the current repl, we can receive the data
      else if (repl.id === id) {
        if (repl.editor.theme !== theme) postmessage({ editor: { theme } });
        else {
          // update the iframe height
          replElement.style.height = repl.dimensions.height + "px";
          // show the iframe and hide the pre element
          iframeElement.style.display = "block";
          replElement.nextElementSibling.style.display = "none";
        }
      }
    });

    // listen to theme change
    document.querySelectorAll("button[role='menuitem'].theme").forEach((btn) => {
      btn.addEventListener("click", (event) => {
        theme = mapTheme(event.target.id);
        postmessage({ editor: { theme } });
      });
    });
  });
</script>
